<script>
	import { geoMercator } from 'd3-geo';
	import inPoly from '@turf/boolean-point-in-polygon';
	import bbox from '@turf/bbox';
	import bboxPoly from '@turf/bbox-polygon';

	export let geometry = null;

	const w = 800;
	const h = 492;
	const pointSpacing = 15;

	const coords = [
		[-1.579, 59.358],
		[-6.488, 58.375],
		[-4.647, 58.375],
		[-4.034, 58.375],
		[-3.42, 58.375],
		[-6.488, 58.052],
		[-5.261, 58.052],
		[-4.647, 58.052],
		[-4.034, 58.052],
		[-5.261, 57.726],
		[-4.647, 57.726],
		[-5.261, 57.396],
		[-4.647, 57.396],
		[-4.034, 57.396],
		[-3.42, 57.396],
		[-2.807, 57.396],
		[-2.193, 57.396],
		[-6.488, 57.064],
		[-5.261, 57.064],
		[-4.647, 57.064],
		[-4.034, 57.064],
		[-3.42, 57.064],
		[-2.807, 57.064],
		[-2.193, 57.064],
		[-5.874, 56.729],
		[-5.261, 56.729],
		[-4.647, 56.729],
		[-4.034, 56.729],
		[-3.42, 56.729],
		[-2.807, 56.729],
		[-5.874, 56.391],
		[-5.261, 56.391],
		[-4.647, 56.391],
		[-4.034, 56.391],
		[-3.42, 56.391],
		[-5.874, 56.05],
		[-5.261, 56.05],
		[-4.647, 56.05],
		[-4.034, 56.05],
		[-3.42, 56.05],
		[-2.807, 56.05],
		[-6.488, 55.706],
		[-5.261, 55.706],
		[-4.647, 55.706],
		[-4.034, 55.706],
		[-3.42, 55.706],
		[-2.807, 55.706],
		[-2.193, 55.706],
		[-4.647, 55.359],
		[-4.034, 55.359],
		[-3.42, 55.359],
		[-2.807, 55.359],
		[-2.193, 55.359],
		[-8.329, 55.008],
		[-7.715, 55.008],
		[-7.102, 55.008],
		[-6.488, 55.008],
		[-4.647, 55.008],
		[-4.034, 55.008],
		[-3.42, 55.008],
		[-2.807, 55.008],
		[-2.193, 55.008],
		[-1.579, 55.008],
		[-8.329, 54.655],
		[-7.715, 54.655],
		[-7.102, 54.655],
		[-6.488, 54.655],
		[-3.42, 54.655],
		[-2.807, 54.655],
		[-2.193, 54.655],
		[-1.579, 54.655],
		[-9.556, 54.298],
		[-8.329, 54.298],
		[-7.715, 54.298],
		[-7.102, 54.298],
		[-6.488, 54.298],
		[-5.874, 54.298],
		[-2.807, 54.298],
		[-2.193, 54.298],
		[-1.579, 54.298],
		[-0.966, 54.298],
		[-9.556, 53.939],
		[-8.942, 53.939],
		[-8.329, 53.939],
		[-7.715, 53.939],
		[-7.102, 53.939],
		[-6.488, 53.939],
		[-2.807, 53.939],
		[-2.193, 53.939],
		[-1.579, 53.939],
		[-0.966, 53.939],
		[-0.352, 53.939],
		[-9.556, 53.576],
		[-8.942, 53.576],
		[-8.329, 53.576],
		[-7.715, 53.576],
		[-7.102, 53.576],
		[-6.488, 53.576],
		[-2.807, 53.576],
		[-2.193, 53.576],
		[-1.579, 53.576],
		[-0.966, 53.576],
		[-0.352, 53.576],
		[-8.329, 53.21],
		[-7.715, 53.21],
		[-7.102, 53.21],
		[-6.488, 53.21],
		[-4.034, 53.21],
		[-3.42, 53.21],
		[-2.807, 53.21],
		[-2.193, 53.21],
		[-1.579, 53.21],
		[-0.966, 53.21],
		[-0.352, 53.21],
		[0.261, 53.21],
		[-8.942, 52.841],
		[-8.329, 52.841],
		[-7.715, 52.841],
		[-7.102, 52.841],
		[-6.488, 52.841],
		[-4.647, 52.841],
		[-4.034, 52.841],
		[-3.42, 52.841],
		[-2.807, 52.841],
		[-2.193, 52.841],
		[-1.579, 52.841],
		[-0.966, 52.841],
		[-0.352, 52.841],
		[0.875, 52.841],
		[1.489, 52.841],
		[-9.556, 52.469],
		[-8.942, 52.469],
		[-8.329, 52.469],
		[-7.715, 52.469],
		[-7.102, 52.469],
		[-6.488, 52.469],
		[-4.034, 52.469],
		[-3.42, 52.469],
		[-2.807, 52.469],
		[-2.193, 52.469],
		[-1.579, 52.469],
		[-0.966, 52.469],
		[-0.352, 52.469],
		[0.261, 52.469],
		[0.875, 52.469],
		[1.489, 52.469],
		[-9.556, 52.093],
		[-8.942, 52.093],
		[-8.329, 52.093],
		[-7.715, 52.093],
		[-4.647, 52.093],
		[-4.034, 52.093],
		[-3.42, 52.093],
		[-2.807, 52.093],
		[-2.193, 52.093],
		[-1.579, 52.093],
		[-0.966, 52.093],
		[-0.352, 52.093],
		[0.261, 52.093],
		[0.875, 52.093],
		[1.489, 52.093],
		[-8.942, 51.715],
		[-4.034, 51.715],
		[-3.42, 51.715],
		[-2.807, 51.715],
		[-2.193, 51.715],
		[-1.579, 51.715],
		[-0.966, 51.715],
		[-0.352, 51.715],
		[0.261, 51.715],
		[0.875, 51.715],
		[-2.807, 51.333],
		[-2.193, 51.333],
		[-1.579, 51.333],
		[-0.966, 51.333],
		[-0.352, 51.333],
		[0.261, 51.333],
		[0.875, 51.333],
		[-4.034, 50.948],
		[-3.42, 50.948],
		[-2.807, 50.948],
		[-2.193, 50.948],
		[-1.579, 50.948],
		[-0.966, 50.948],
		[-0.352, 50.948],
		[0.261, 50.948],
		[0.875, 50.948],
		[-4.647, 50.56],
		[-4.034, 50.56],
		[-5.261, 50.169]
	];

	const points = {
		type: 'FeatureCollection',
		features: coords.map((c) => ({
			type: 'Feature',
			properties: {},
			geometry: { type: 'Point', coordinates: c }
		}))
	};

	const proj = geoMercator().fitExtent(
		[
			[0, 20],
			[w, h - 20]
		],
		points
	);

	function nearestPoint(points, bb) {
		const dist = (c1, c2) => Math.pow(c1[0] - c2[0], 2) + Math.pow(c1[1] - c2[1], 2);
		const centroid = [(bb[0] + bb[2]) / 2, (bb[1] + bb[3]) / 2];
		let filtered = points.features.filter((ft) =>
			inPoly(ft, bboxPoly([bb[0] - 1, bb[1] - 1, bb[2] + 1, bb[3] + 1]))
		);
		let nearest = filtered[0];
		for (const ft of filtered) {
			if (dist(centroid, ft.geometry.coordinates) < dist(centroid, nearest.geometry.coordinates))
				nearest = ft;
		}
		return nearest;
	}

	function filterPoints(points, polygon) {
		const bb = bbox(polygon);
		const bbPoly = bboxPoly(bb);

		let filtered = points.features.filter((ft) => inPoly(ft, bbPoly) && inPoly(ft, polygon));

		if (filtered.length === 0) {
			filtered = [nearestPoint(points, bb)];
		}
		return { type: 'FeatureCollection', features: filtered };
	}
</script>

<svg viewBox="0 0 {w} {h}" class="svg-icon" alt="">
	{#each points.features.map((pt) => proj(pt.geometry.coordinates)) as pt}
		<circle cx={pt[0]} cy={pt[1]} r={pointSpacing / 2 - 1} fill-opacity="0.25" />
	{/each}
	{#if geometry}
		{#each filterPoints(points, geometry).features.map((pt) => proj(pt.geometry.coordinates)) as pt}
			<circle cx={pt[0]} cy={pt[1]} r={pointSpacing / 2 - 1} />
		{/each}
	{/if}
</svg>

<style>
	.svg-icon {
		width: 100%;
		margin-bottom: 12px !important;
		background: #003c57;
		overflow: visible;
	}
	.svg-icon > circle {
		fill: white;
	}
</style>
