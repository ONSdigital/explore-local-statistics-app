<script>
	import { geoEquirectangular } from 'd3-geo';
	import inPoly from '@turf/boolean-point-in-polygon';
	import bbox from '@turf/bbox';
	import bboxPoly from '@turf/bbox-polygon';

	export let geometry = null;

	const w = 400;
	const h = 400;
	const pointSpacing = 15;

	const coords = [
		[-1.299, 60.257],
		[-6.347, 58.422],
		[-4.971, 58.422],
		[-4.512, 58.422],
		[-4.053, 58.422],
		[-3.594, 58.422],
		[-3.135, 58.422],
		[-6.806, 57.963],
		[-4.971, 57.963],
		[-4.512, 57.963],
		[-4.053, 57.963],
		[-5.429, 57.504],
		[-4.971, 57.504],
		[-4.512, 57.504],
		[-4.053, 57.504],
		[-3.594, 57.504],
		[-3.135, 57.504],
		[-2.676, 57.504],
		[-2.217, 57.504],
		[-6.347, 57.045],
		[-5.429, 57.045],
		[-4.971, 57.045],
		[-4.512, 57.045],
		[-4.053, 57.045],
		[-3.594, 57.045],
		[-3.135, 57.045],
		[-2.676, 57.045],
		[-2.217, 57.045],
		[-5.888, 56.586],
		[-4.971, 56.586],
		[-4.512, 56.586],
		[-4.053, 56.586],
		[-3.594, 56.586],
		[-3.135, 56.586],
		[-2.676, 56.586],
		[-5.429, 56.127],
		[-4.971, 56.127],
		[-4.512, 56.127],
		[-4.053, 56.127],
		[-3.594, 56.127],
		[-3.135, 56.127],
		[-4.512, 55.668],
		[-4.053, 55.668],
		[-3.594, 55.668],
		[-3.135, 55.668],
		[-2.676, 55.668],
		[-2.217, 55.668],
		[-7.724, 55.209],
		[-7.265, 55.209],
		[-6.347, 55.209],
		[-4.512, 55.209],
		[-4.053, 55.209],
		[-3.594, 55.209],
		[-3.135, 55.209],
		[-2.676, 55.209],
		[-2.217, 55.209],
		[-1.758, 55.209],
		[-8.642, 54.75],
		[-8.183, 54.75],
		[-7.724, 54.75],
		[-7.265, 54.75],
		[-6.806, 54.75],
		[-6.347, 54.75],
		[-5.888, 54.75],
		[-4.971, 54.75],
		[-4.512, 54.75],
		[-3.135, 54.75],
		[-2.676, 54.75],
		[-2.217, 54.75],
		[-1.758, 54.75],
		[-1.299, 54.75],
		[-9.56, 54.291],
		[-8.183, 54.291],
		[-7.724, 54.291],
		[-7.265, 54.291],
		[-6.806, 54.291],
		[-6.347, 54.291],
		[-5.888, 54.291],
		[-3.135, 54.291],
		[-2.676, 54.291],
		[-2.217, 54.291],
		[-1.758, 54.291],
		[-1.299, 54.291],
		[-0.84, 54.291],
		[-9.56, 53.832],
		[-9.101, 53.832],
		[-8.642, 53.832],
		[-8.183, 53.832],
		[-7.724, 53.832],
		[-7.265, 53.832],
		[-6.806, 53.832],
		[-6.347, 53.832],
		[-2.676, 53.832],
		[-2.217, 53.832],
		[-1.758, 53.832],
		[-1.299, 53.832],
		[-0.84, 53.832],
		[-0.381, 53.832],
		[-9.56, 53.373],
		[-9.101, 53.373],
		[-8.642, 53.373],
		[-8.183, 53.373],
		[-7.724, 53.373],
		[-7.265, 53.373],
		[-6.806, 53.373],
		[-6.347, 53.373],
		[-4.512, 53.373],
		[-3.135, 53.373],
		[-2.676, 53.373],
		[-2.217, 53.373],
		[-1.758, 53.373],
		[-1.299, 53.373],
		[-0.84, 53.373],
		[-0.381, 53.373],
		[0.078, 53.373],
		[-9.101, 52.914],
		[-8.642, 52.914],
		[-8.183, 52.914],
		[-7.724, 52.914],
		[-7.265, 52.914],
		[-6.806, 52.914],
		[-6.347, 52.914],
		[-4.512, 52.914],
		[-4.053, 52.914],
		[-3.594, 52.914],
		[-3.135, 52.914],
		[-2.676, 52.914],
		[-2.217, 52.914],
		[-1.758, 52.914],
		[-1.299, 52.914],
		[-0.84, 52.914],
		[-0.381, 52.914],
		[0.537, 52.914],
		[0.996, 52.914],
		[-9.56, 52.455],
		[-9.101, 52.455],
		[-8.642, 52.455],
		[-8.183, 52.455],
		[-7.724, 52.455],
		[-7.265, 52.455],
		[-6.806, 52.455],
		[-6.347, 52.455],
		[-4.053, 52.455],
		[-3.594, 52.455],
		[-3.135, 52.455],
		[-2.676, 52.455],
		[-2.217, 52.455],
		[-1.758, 52.455],
		[-1.299, 52.455],
		[-0.84, 52.455],
		[-0.381, 52.455],
		[0.078, 52.455],
		[0.537, 52.455],
		[0.996, 52.455],
		[1.455, 52.455],
		[-10.019, 51.996],
		[-9.56, 51.996],
		[-9.101, 51.996],
		[-8.642, 51.996],
		[-8.183, 51.996],
		[-7.724, 51.996],
		[-4.971, 51.996],
		[-4.512, 51.996],
		[-4.053, 51.996],
		[-3.594, 51.996],
		[-3.135, 51.996],
		[-2.676, 51.996],
		[-2.217, 51.996],
		[-1.758, 51.996],
		[-1.299, 51.996],
		[-0.84, 51.996],
		[-0.381, 51.996],
		[0.078, 51.996],
		[0.537, 51.996],
		[0.996, 51.996],
		[-9.56, 51.537],
		[-3.594, 51.537],
		[-3.135, 51.537],
		[-2.676, 51.537],
		[-2.217, 51.537],
		[-1.758, 51.537],
		[-1.299, 51.537],
		[-0.84, 51.537],
		[-0.381, 51.537],
		[0.078, 51.537],
		[0.537, 51.537],
		[-4.053, 51.078],
		[-3.594, 51.078],
		[-3.135, 51.078],
		[-2.676, 51.078],
		[-2.217, 51.078],
		[-1.758, 51.078],
		[-1.299, 51.078],
		[-0.84, 51.078],
		[-0.381, 51.078],
		[0.078, 51.078],
		[0.537, 51.078],
		[0.996, 51.078],
		[-4.512, 50.619],
		[-4.053, 50.619],
		[-3.594, 50.619],
		[-1.299, 50.619],
		[-5.429, 50.16]
	];

	const points = {
		type: 'FeatureCollection',
		features: coords.map((c) => ({
			type: 'Feature',
			properties: {},
			geometry: { type: 'Point', coordinates: c }
		}))
	};

	const proj = geoEquirectangular().fitExtent(
		[
			[0, 0],
			[w, h]
		],
		points
	);

	function nearestPoint(points, bb) {
		const dist = (c1, c2) => Math.pow(c1[0] - c2[0], 2) + Math.pow(c1[1] - c2[1], 2);
		const centroid = [(bb[0] + bb[2]) / 2, (bb[1] + bb[3]) / 2];
		let filtered = points.features.filter((ft) =>
			inPoly(ft, bboxPoly([bb[0] - 1, bb[1] - 1, bb[2] + 1, bb[3] + 1]))
		);
		let nearest = filtered[0];
		for (const ft of filtered) {
			if (dist(centroid, ft.geometry.coordinates) < dist(centroid, nearest.geometry.coordinates))
				nearest = ft;
		}
		return nearest;
	}

	function filterPoints(points, polygon) {
		const bb = bbox(polygon);
		const bbPoly = bboxPoly(bb);

		let filtered = points.features.filter((ft) => inPoly(ft, bbPoly) && inPoly(ft, polygon));

		console.log(bb, bbPoly, filtered);
		if (filtered.length === 0) {
			filtered = [nearestPoint(points, bb)];
		}
		return { type: 'FeatureCollection', features: filtered };
	}
</script>

<svg viewBox="0 0 {w} {h}" class="svg-icon">
	{#each points.features.map((pt) => proj(pt.geometry.coordinates)) as pt}
		<circle cx={pt[0]} cy={pt[1]} r={pointSpacing / 2 - 1} fill-opacity="0.2" fill="white" />
	{/each}
	{#if geometry}
		{#each filterPoints(points, geometry).features.map((pt) => proj(pt.geometry.coordinates)) as pt}
			<circle cx={pt[0]} cy={pt[1]} r={pointSpacing / 2 - 1} fill="white" />
		{/each}
	{/if}
</svg>

<style>
	.svg-icon {
		position: absolute;
		top: 50%;
		right: 30px;
		height: 200px;
		transform: translateY(-50%);
		overflow: visible;
	}
	@media (max-width: 800px) {
		.svg-icon {
			display: none;
		}
	}
</style>
